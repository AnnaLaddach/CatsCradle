---
title: "Cats Cradle Overview
author: "Anna Laddach and Michael Shapiro"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
    %\VignetteIndexEntry{CatsCradleOverview}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    fig.dim = c(6,6),
    comment = "#>"
)
```
## Introduction

Cats Cradle provides two types of functionality for analysing single
cell data.  It provides tools for the clustering and annotation of
genes and it provides extensive tools for analysing spatial
transcriptomic data.

## Clustering and annotation of genes

A typical Seurat analysis involves dimension reduction (PCA, UMAP,
tSNE) and the clustering of cells using the louvain algorithm. All of
this is done based on the similarities and differences in the genes
they express.

```{r}
library(Seurat)
library(CatsCradle)
DimPlot(S,cols='polychrome')
```

By transposing the expression matrix, we can use the same technology
to produce a Seurat object where the objects are the genes.  They have
their own UMAP and their own clustering.  This is all done on the
basis of the similarities and differences in the cells they are
expressed in.

```{r}
library(Seurat)
library(CatsCradle)
DimPlot(STranspose,cols='polychrome')
```

### Gene clusters vs. cell clusters

There are a number of ways of investigating the relationship between
gene clusters and cell clusters.  One is by computing the average
expression of each gene cluster in each cell cluster and this can be
displayed as a heat map or a Sankey graph - the cat's cradle of our
CatsCradle. (See getAverageExpressionMatrix() and sankeyFromMatrix()
in the CatsCradle vignette.)  

### Spatial co-location on gene UMAP

Gene sets such as Hallmark tend to localise on gene UMAP, though they
are not necessarily confined to specific gene clusters.  Here we show
HALLMARK_OXIDATIVE_PHOSPHORYLATION.

```{r}
h = 'HALLMARK_OXIDATIVE_PHOSPHORYLATION'
umap = FetchData(STranspose,c('umap_1','umap_2'))
idx = colnames(STranspose) %in% hallmark[[h]]
g = DimPlot(STranspose,cols='polychrome') +
    geom_point(data=umap[idx,],aes(x=umap_1,y=umap_2),color='black') +
    ggtitle(paste(h,'on gene clusters'))
print(g)
pValue = getSubsetClusteringPValue(STranspose,idx)
```

This reports a p-value for the geometric clustering of these genes of
0.001. Here this is limited by the default number of randomisation
trials in getSubsetClusteringPValue().  Of the 50 Hallmark gene sets,
31 have clustering p-values less than 0.05.

### Gene annotation

This suggests propose annotations for a given gene by looking at
annotations for its neighbouring genes.  If a gene has its own
annotation and also has neighbours which have annotations, we can
compare the actual annotation to the predicted annotation based on its
neighbours. The predictions perform well above chance.  This is
described in the section Predicting gene function of the CatsCradle
vignette.
 


## Analysis of spatial transcriptomic data

